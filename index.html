<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°°ë“œë¯¼í„´ ëª¨ì„ ì°¸ê°€ ì‹ ì²­</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111824;
      --muted: #8aa0b7;
      --text: #e9f0f7;
      --line: #223246;
      --accent: #2dd4bf;
      --warn: #fbbf24;
      --ok: #22c55e;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1000px 600px at 20% 0%, #0d1b2a 0%, var(--bg) 55%);
      color: var(--text);
      padding: 24px;
    }
    .wrap { max-width: 980px; margin: 0 auto; }
    header { display:flex; justify-content:space-between; gap:16px; align-items:flex-end; margin-bottom: 18px; }
    h1 { margin: 0; font-size: 22px; letter-spacing: -0.2px; }
    .sub { margin: 6px 0 0; color: var(--muted); font-size: 13px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 380px 1fr; } }

    .card {
      background: rgba(17,24,36,0.92);
      border: 1px solid rgba(34,50,70,0.9);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
    }
    .row { display:flex; gap:10px; align-items:center; }
    .row.space { justify-content:space-between; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(34,50,70,0.9);
      background: rgba(9,13,20,0.5);
      color: var(--muted); font-size: 12px;
    }
    .btn {
      appearance: none; border: 1px solid rgba(34,50,70,0.9);
      background: rgba(9,13,20,0.55); color: var(--text);
      padding: 10px 12px; border-radius: 12px;
      cursor: pointer; font-weight: 600;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover { border-color: rgba(45,212,191,0.6); background: rgba(9,13,20,0.8); }
    .btn:active { transform: translateY(1px); }
    .btn.primary {
      background: rgba(45,212,191,0.18);
      border-color: rgba(45,212,191,0.55);
    }
    .btn.primary:hover { background: rgba(45,212,191,0.25); }

    form { display:grid; gap: 10px; margin-top: 10px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34,50,70,0.9);
      background: rgba(9,13,20,0.55);
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus { border-color: rgba(45,212,191,0.7); }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .hint { font-size: 12px; color: var(--muted); line-height: 1.45; }

    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top: 4px; }
    .search { flex: 1; min-width: 200px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align:left; padding: 10px 10px; border-bottom: 1px solid rgba(34,50,70,0.75); font-size: 13px; }
    th { color: #cfe3f7; font-size: 12px; letter-spacing: .2px; }
    tr:hover td { background: rgba(9,13,20,0.35); }
    .status {
      display:inline-flex; align-items:center; gap:8px;
      font-weight: 700; font-size: 12px;
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; display:inline-block; }
    .s-wait { color: var(--warn); }
    .s-wait .dot { background: var(--warn); }
    .s-ok { color: var(--ok); }
    .s-ok .dot { background: var(--ok); }
    .s-bad { color: var(--bad); }
    .s-bad .dot { background: var(--bad); }

    .toast {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34,50,70,0.9);
      background: rgba(9,13,20,0.55);
      color: var(--muted);
      display:none;
    }
    .toast.show { display:block; }
    .small { font-size: 12px; color: var(--muted); }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ë°°ë“œë¯¼í„´ ëª¨ì„ ì°¸ê°€ ì‹ ì²­</h1>
        <p class="sub">êµ¬ê¸€ ì‹œíŠ¸ì™€ ì—°ë™ëœ ì‹¤ì‹œê°„ ëª…ë‹¨(ëŒ€ê¸°/ì°¸ê°€ í‘œì‹œ)</p>
      </div>
      <div class="row">
        <span class="pill" id="syncPill">â³ ë™ê¸°í™” ì¤€ë¹„ ì¤‘â€¦</span>
        <button class="btn" id="refreshBtn" type="button">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </header>

    <div class="grid">
      <!-- ì‹ ì²­ í¼ -->
      <section class="card">
        <div class="row space">
          <div>
            <div style="font-weight:800;">ì°¸ê°€ ì‹ ì²­</div>
            <div class="small">ì…ë ¥í•˜ë©´ ì¦‰ì‹œ ëª…ë‹¨ì— â€œëŒ€ê¸° ì¤‘â€ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.</div>
          </div>
        </div>

        <form id="applyForm">
          <div>
            <label for="name">ì´ë¦„</label>
            <input id="name" name="name" placeholder="ì˜ˆ: ìµœìœ¤ì„œ" required maxlength="30" />
          </div>

          <div class="two">
            <div>
              <label for="level">ê¸‰ìˆ˜</label>
              <select id="level" name="level" required>
                <option value="" disabled selected>ì„ íƒ</option>
                <option>ì´ˆì‹¬</option>
                <option>D</option>
                <option>C</option>
                <option>B</option>
                <option>A</option>
                <option>ìƒê´€ì—†ìŒ</option>
              </select>
            </div>
            <div>
              <label for="gender">ì„±ë³„</label>
              <select id="gender" name="gender" required>
                <option value="" disabled selected>ì„ íƒ</option>
                <option>ì—¬</option>
                <option>ë‚¨</option>
                <option>ê¸°íƒ€</option>
                <option>ë¹„ê³µê°œ</option>
              </select>
            </div>
          </div>

          <button class="btn primary" type="submit" id="submitBtn">ì‹ ì²­í•˜ê¸°</button>

          <div class="hint">
            <b>ì—°ë™ ë°©ì‹</b><br/>
            ì´ í˜ì´ì§€ëŠ” Google Apps Script(ì›¹ì•±) APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.<br/>
            ì•„ë˜ <code>CONFIG</code>ì˜ <code>API_BASE</code>ì— ë³¸ì¸ ì›¹ì•± URLì„ ë„£ì–´ì£¼ì„¸ìš”.
          </div>

          <div class="toast" id="toast"></div>
        </form>
      </section>

      <!-- ëª…ë‹¨ -->
      <section class="card">
        <div class="row space">
          <div>
            <div style="font-weight:800;">í˜„ì¬ ëª…ë‹¨</div>
            <div class="small" id="countText">0ëª…</div>
          </div>
          <div class="row">
            <span class="pill" id="autoPill">ğŸ”„ ìë™ ê°±ì‹ : 10ì´ˆ</span>
            <button class="btn" type="button" id="toggleAutoBtn">ìë™ ê°±ì‹  ë„ê¸°</button>
          </div>
        </div>

        <div class="toolbar">
          <input class="search" id="search" placeholder="ì´ë¦„/ê¸‰ìˆ˜/ì„±ë³„ ê²€ìƒ‰" />
          <select id="filterStatus" style="max-width: 180px;">
            <option value="all" selected>ìƒíƒœ: ì „ì²´</option>
            <option value="ëŒ€ê¸°">ëŒ€ê¸°ë§Œ</option>
            <option value="ì°¸ê°€">ì°¸ê°€ë§Œ</option>
          </select>
          <select id="sortBy" style="max-width: 220px;">
            <option value="time_desc" selected>ì •ë ¬: ìµœì‹  ì‹ ì²­ìˆœ</option>
            <option value="time_asc">ì •ë ¬: ì˜¤ë˜ëœ ì‹ ì²­ìˆœ</option>
            <option value="name_asc">ì •ë ¬: ì´ë¦„ìˆœ</option>
          </select>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width: 110px;">ìƒíƒœ</th>
              <th>ì´ë¦„</th>
              <th style="width: 90px;">ê¸‰ìˆ˜</th>
              <th style="width: 90px;">ì„±ë³„</th>
              <th style="width: 170px;">ì‹ ì²­ì‹œê°„</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" style="color:var(--muted); padding:14px;">ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>
          </tbody>
        </table>

        <div class="small" style="margin-top:10px;">
          â€» êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ìƒíƒœ ì¹¼ëŸ¼ì„ <b>â€œì°¸ê°€â€</b>ë¡œ ë°”ê¾¸ë©´ ì—¬ê¸°ì—ë„ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.
        </div>
      </section>
    </div>

    <!--
      ============================
      âœ… ì„œë²„(êµ¬ê¸€ ì‹œíŠ¸) êµ¬ì„± ìš”ì•½
      ============================

      1) êµ¬ê¸€ ì‹œíŠ¸ì— ì•„ë˜ í—¤ë”(1í–‰)ë¥¼ ë§Œë“œì„¸ìš” (ê¶Œì¥):
         A: id
         B: name
         C: level
         D: gender
         E: status   (ê¸°ë³¸ê°’: "ëŒ€ê¸°")
         F: createdAt (ISO ë¬¸ìì—´)

      2) Google Apps Script ë§Œë“¤ê¸° (í™•ì¥ í”„ë¡œê·¸ë¨ > Apps Script)
         - doGet(e): JSONìœ¼ë¡œ ëª©ë¡ ë°˜í™˜
         - doPost(e): ì‹ ì²­ ë“±ë¡(append) í›„ JSON ë°˜í™˜
         - ì›¹ì•±ìœ¼ë¡œ ë°°í¬(ì‹¤í–‰: ë‚˜ / ì ‘ê·¼: ëˆ„êµ¬ë‚˜) í›„ URLì„ ì•„ë˜ API_BASEì— ë„£ê¸°

      3) CORS:
         Apps ScriptëŠ” fetchì—ì„œ CORS ì´ìŠˆê°€ ë‚  ìˆ˜ ìˆì–´
         ë³´í†µ "ContentService"ë¡œ JSONì„ ì£¼ê³ , í”„ë¡ íŠ¸ëŠ” same-originì´ ì•„ë‹ˆë¼ì„œ ë§‰í ìˆ˜ ìˆìŠµë‹ˆë‹¤.
         âœ… ê°€ì¥ ì‰¬ìš´ ë°©ë²•: doGet/doPost ì‘ë‹µì„ JSONP ë˜ëŠ” "Access-Control-Allow-Origin"ì„
         ì§ì ‘ í—¤ë”ë¡œ ë‹¬ ìˆ˜ ì—†ëŠ” ì œì•½ì´ ìˆì–´,
         í˜„ì‹¤ì ìœ¼ë¡œëŠ”:
         - (ì¶”ì²œ) Apps Scriptë¥¼ "ì›¹ì•±"ìœ¼ë¡œ ë°°í¬í•˜ê³ , í”„ë¡ íŠ¸ë„ ê°™ì€ ë„ë©”ì¸(Google Sites ë“±)ì—ì„œ ë„ìš°ê±°ë‚˜
         - (ëŒ€ì•ˆ) Cloudflare Pages/Netlify ë“± + Apps ScriptëŠ” `?callback=` JSONP í˜•íƒœë¡œ ì²˜ë¦¬

      ì•„ë˜ í”„ë¡ íŠ¸ ì½”ë“œëŠ” "ì¼ë°˜ CORS í—ˆìš© í™˜ê²½"ì„ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.
      ë§Œì•½ CORS ë•Œë¬¸ì— ë§‰íˆë©´ ë§í•´ì¤˜. JSONP ë²„ì „ìœ¼ë¡œ ë°”ê¿”ì¤„ê²Œ.
    -->
  </div>

  <script>
    // =========================
    // âœ… CONFIG: ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨
    // =========================
    const CONFIG = {
      // ì˜ˆ) "https://script.google.com/macros/s/AKfycbx.../exec"
      API_BASE: "PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE",

      // ìë™ ìƒˆë¡œê³ ì¹¨ ê°„ê²©(ms)
      POLL_MS: 10_000,
    };

    // =========================
    // UI helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function setPill(text, ok = false) {
      const pill = $("syncPill");
      pill.textContent = text;
      pill.style.borderColor = ok ? "rgba(34,197,94,0.55)" : "rgba(34,50,70,0.9)";
      pill.style.color = ok ? "rgba(34,197,94,0.9)" : "var(--muted)";
    }

    function toast(msg, type = "info") {
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      if (type === "ok") {
        el.style.borderColor = "rgba(34,197,94,0.55)";
        el.style.color = "rgba(34,197,94,0.9)";
      } else if (type === "bad") {
        el.style.borderColor = "rgba(239,68,68,0.55)";
        el.style.color = "rgba(239,68,68,0.9)";
      } else {
        el.style.borderColor = "rgba(34,50,70,0.9)";
        el.style.color = "var(--muted)";
      }
      setTimeout(() => el.classList.remove("show"), 3500);
    }

    function fmtTime(iso) {
      try {
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return iso ?? "";
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}-${m}-${day} ${hh}:${mm}`;
      } catch {
        return iso ?? "";
      }
    }

    function statusChip(statusRaw) {
      const status = (statusRaw || "ëŒ€ê¸°").trim();
      if (status === "ì°¸ê°€") {
        return `<span class="status s-ok"><span class="dot"></span>ì°¸ê°€</span>`;
      }
      if (status === "ë¶ˆì°¸" || status === "ì·¨ì†Œ") {
        return `<span class="status s-bad"><span class="dot"></span>${status}</span>`;
      }
      return `<span class="status s-wait"><span class="dot"></span>ëŒ€ê¸°</span>`;
    }

    // =========================
    // API
    // =========================
    async function apiGetList() {
      if (!CONFIG.API_BASE || CONFIG.API_BASE.includes("PASTE_")) {
        throw new Error("CONFIG.API_BASEì— Apps Script ì›¹ì•± URLì„ ë„£ì–´ì£¼ì„¸ìš”.");
      }
      const url = new URL(CONFIG.API_BASE);
      url.searchParams.set("action", "list");
      // ìºì‹œ ë°©ì§€
      url.searchParams.set("_t", String(Date.now()));

      const res = await fetch(url.toString(), { method: "GET" });
      if (!res.ok) throw new Error(`ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (${res.status})`);
      const data = await res.json();
      if (!data || !Array.isArray(data.items)) throw new Error("ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return data.items;
    }

    async function apiApply(payload) {
      if (!CONFIG.API_BASE || CONFIG.API_BASE.includes("PASTE_")) {
        throw new Error("CONFIG.API_BASEì— Apps Script ì›¹ì•± URLì„ ë„£ì–´ì£¼ì„¸ìš”.");
      }

      const res = await fetch(CONFIG.API_BASE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "apply", ...payload }),
      });

      if (!res.ok) throw new Error(`ì‹ ì²­ ì‹¤íŒ¨ (${res.status})`);
      const data = await res.json();
      if (!data || data.ok !== true) throw new Error(data?.error || "ì‹ ì²­ ì²˜ë¦¬ ì‹¤íŒ¨");
      return data;
    }

    // =========================
    // Render
    // =========================
    let allItems = [];
    function applyFiltersAndRender() {
      const q = $("search").value.trim().toLowerCase();
      const f = $("filterStatus").value;
      const sortBy = $("sortBy").value;

      let items = [...allItems];

      if (q) {
        items = items.filter((it) => {
          const s = `${it.name ?? ""} ${it.level ?? ""} ${it.gender ?? ""} ${it.status ?? ""}`.toLowerCase();
          return s.includes(q);
        });
      }

      if (f !== "all") {
        items = items.filter((it) => (it.status ?? "ëŒ€ê¸°").trim() === f);
      }

      if (sortBy === "time_desc") {
        items.sort((a, b) => (new Date(b.createdAt).getTime() || 0) - (new Date(a.createdAt).getTime() || 0));
      } else if (sortBy === "time_asc") {
        items.sort((a, b) => (new Date(a.createdAt).getTime() || 0) - (new Date(b.createdAt).getTime() || 0));
      } else if (sortBy === "name_asc") {
        items.sort((a, b) => String(a.name ?? "").localeCompare(String(b.name ?? ""), "ko"));
      }

      $("countText").textContent = `${items.length}ëª…`;

      const tbody = $("tbody");
      if (items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted); padding:14px;">í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      tbody.innerHTML = items.map((it) => {
        return `
          <tr>
            <td>${statusChip(it.status)}</td>
            <td style="font-weight:700;">${escapeHtml(it.name ?? "")}</td>
            <td>${escapeHtml(it.level ?? "")}</td>
            <td>${escapeHtml(it.gender ?? "")}</td>
            <td style="color:var(--muted);">${escapeHtml(fmtTime(it.createdAt ?? ""))}</td>
          </tr>
        `;
      }).join("");
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // =========================
    // Polling
    // =========================
    let pollTimer = null;
    let autoOn = true;

    function startPolling() {
      stopPolling();
      pollTimer = setInterval(() => {
        if (autoOn) refreshList(false);
      }, CONFIG.POLL_MS);
    }
    function stopPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
    }

    // =========================
    // Main actions
    // =========================
    async function refreshList(showToast = true) {
      try {
        setPill("ğŸ”„ ë™ê¸°í™” ì¤‘â€¦");
        const items = await apiGetList();
        allItems = items;
        applyFiltersAndRender();
        setPill(`âœ… ë™ê¸°í™” ì™„ë£Œ (${fmtTime(new Date().toISOString())})`, true);
        if (showToast) toast("ëª…ë‹¨ì„ ìƒˆë¡œ ë¶ˆëŸ¬ì™”ì–´ìš”.", "ok");
      } catch (e) {
        setPill("âš ï¸ ë™ê¸°í™” ì‹¤íŒ¨");
        if (showToast) toast(e.message || "ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜", "bad");
        // í‘œì—ë„ ì•ˆë‚´
        $("tbody").innerHTML = `<tr><td colspan="5" style="color:var(--muted); padding:14px;">
          ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${escapeHtml(e.message || "ì˜¤ë¥˜")}<br/>
          <span class="small">CONFIG.API_BASE ì„¤ì • ë˜ëŠ” Apps Script ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.</span>
        </td></tr>`;
      }
    }

    async function onSubmit(e) {
      e.preventDefault();
      const name = $("name").value.trim();
      const level = $("level").value;
      const gender = $("gender").value;

      if (!name || !level || !gender) {
        toast("ì´ë¦„/ê¸‰ìˆ˜/ì„±ë³„ì„ ëª¨ë‘ ì…ë ¥í•´ì¤˜!", "bad");
        return;
      }

      $("submitBtn").disabled = true;
      $("submitBtn").textContent = "ì‹ ì²­ ì¤‘â€¦";

      try {
        await apiApply({ name, level, gender });
        toast("ì‹ ì²­ ì™„ë£Œ! ëª…ë‹¨ì— â€˜ëŒ€ê¸°â€™ë¡œ ë“±ë¡ëì–´ìš”.", "ok");
        $("applyForm").reset();
        // ì¦‰ì‹œ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        await refreshList(false);
      } catch (err) {
        toast(err.message || "ì‹ ì²­ ì˜¤ë¥˜", "bad");
      } finally {
        $("submitBtn").disabled = false;
        $("submitBtn").textContent = "ì‹ ì²­í•˜ê¸°";
      }
    }

    // =========================
    // Event wiring
    // =========================
    $("applyForm").addEventListener("submit", onSubmit);
    $("refreshBtn").addEventListener("click", () => refreshList(true));

    $("search").addEventListener("input", applyFiltersAndRender);
    $("filterStatus").addEventListener("change", applyFiltersAndRender);
    $("sortBy").addEventListener("change", applyFiltersAndRender);

    $("toggleAutoBtn").addEventListener("click", () => {
      autoOn = !autoOn;
      $("toggleAutoBtn").textContent = autoOn ? "ìë™ ê°±ì‹  ë„ê¸°" : "ìë™ ê°±ì‹  ì¼œê¸°";
      $("autoPill").textContent = autoOn ? `ğŸ”„ ìë™ ê°±ì‹ : ${Math.round(CONFIG.POLL_MS/1000)}ì´ˆ` : "â¸ ìë™ ê°±ì‹ : OFF";
      toast(autoOn ? "ìë™ ê°±ì‹ ì„ ì¼°ì–´ìš”." : "ìë™ ê°±ì‹ ì„ ê»ì–´ìš”.", "ok");
    });

    // ì´ˆê¸° ë¡œë“œ
    refreshList(false);
    startPolling();
  </script>
</body>
</html>
